---
title: "Getting started with RLumCarlo"
author: "Sebastian Kreutzer, Johannes Friedrich, Vasilis Pagonis, Christoph Schmidt"
date: "Last modified: `r Sys.Date()`"
output: pdf_document
vignette: |
  %\VignetteIndexEntry{RLumCarlo - Getting started with RLumCarlo}         
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}{inputenc}
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(RLumCarlo)
```

```{r, echo = FALSE, fig.align='center', message = FALSE}
knitr::include_graphics("../man/figures/Logo_RLumCarlo.png")
library(ggplot2)
library(scales)
library(kableExtra)

##https://github.com/JohannesFriedrich/EnergyBandModels
theme <- theme(axis.text = element_text(size = 14),
             axis.title = element_text(size = 14, face = "bold"),
             legend.text = element_text(size = 12),
             legend.title = element_text(size = 12, face = "bold"))

electrons <- data.frame(
  x = seq(0,1, length.out = 10),
  y = rep(c(-2.2,-1.5, -1, -0.6, -0.3, 0), each = 10)
)
```

# Scope

RLumCarlo is collection of energy-band models to simulate luminescence signals using Monte-Carlo (MC) methods. This document aims at providing an overview and a brief introduction to RLumCarlo. 

# The models in RLumCarlo

The following tables lists the models implemented in RLumCarlo along with the R function call 
and the corresponding R and C++ files. The modelling takes place in the C++ functions which 
are wrapped by the R functions with a similar name. If you, however, want to cross-check the 
code, you should inspect files with the ending '.cpp'. 

```{r, echo = FALSE, message=FALSE}
## extract models
models <- list.files("../R/", pattern = "run_")
models <- strtrim(models, nchar(models) - 2)
models <- regmatches(models, regexpr("(?<=run\\_).*", models, perl = TRUE), invert = FALSE)

## combine into data.frame
df <- data.frame(
  `MODEL NAME` = models, 
  `R CALL` = paste0("run_", models, "()"),
  `FILES` = paste0("R/run_", models, ".R \n src/MC_C_", models, ".cpp"), 
  stringsAsFactors = FALSE)

knitr::kable(df, booktabs = TRUE, linesep = "\\addlinespace") %>% 
  kable_styling(full_width = TRUE, font_size = 8) %>%
  column_spec(1, bold = TRUE)
```

Each model can be run by calling one of the **R** functions starting with `run_`. Currently 
three different model types (TUN: tunneling, LOC: localised transition, DELOC: delocalised 
transition) are implemented for the stimulation types TL, IRSL, LM-OSL, and ISO (isothermal). 
Please note that each model has different parameters and requirements. 

# Examples

## Example 1: A first example

The first examples simulates an iso-thermal curve using the tunneling model. 
```{r Fig 1, fig.align='center', cache=TRUE}
results <- run_MC_ISO_TUN(
  E = 1.2,
  s = 1e10,
  T = 200,
  rho = 0.007,
  times = seq(0, 5000)
) %T>%
  plot_RLumCarlo(norm = TRUE, legend = TRUE)
```

The modelling output is an object of class `RLumCarlo_Model_Output`, which is basically 
a list consisting of an array and a vector. 

```{r}
str(results)
```

While this represents the full modelling output results, the interpretation might be less 
straight forward and the user may want to condense the information via `summary()`. 
The function `summary()` is also used internally by the function `plot_RLumCarlo()`.

```{r}
df <- summary(results)
head(df)
```

The call summarises the modelling results and returns a terminal output and a `data.frame` with, 
e.g., the mean or the standard deviation, which can be used to create plots for further insight. 
For instance, the stimulation time agains the relative standard deviation: 

```{r, fig.align="center"}
plot(
  x = df$time,
  y = (df$sd / df$mean) * 100,
  pch = 20, 
  col = rgb(0,0,0,.1),
  xlab = "Stimulation time [s]",
  ylab = "cv [%]"
)
```

## Example 2: Combining two plots

The following example uses continuous wave (CW) infrared light stimulation (IRSL), and combines
two plots in one single plot window.

```{r Fig 2, fig.align='center'}
times <- seq(0, 1000)

## Run MC simulation
run_MC_CW_IRSL_TUN(A = 0.12, rho = 0.003, times = times) %>%
  plot_RLumCarlo(norm = TRUE, legend = TRUE)

run_MC_CW_IRSL_TUN(A = 0.21, rho = 0.003, times = times) %>%
  plot_RLumCarlo(norm = TRUE, add = TRUE)
```

## Example 3: Testing parameters

The example above can be further extended to test the effect of different parameters. 
Contrary to the example above, here the results are stored in a `list` and `plot_RLumCarlo()` 
is called only one time. 

```{r Fig 3, fig.align='center', cache = TRUE}
s <- 3.5e12
rho <- 0.015
E <- 1.45
r_c <- c(0,0.7,0.77,0.86, 0.97)
times <- seq(100, 450) # time = temperature
results <- lapply(r_c, function(x) {
  run_MC_TL_TUN(
    s = s,
    E = E,
    rho = rho,
    r_c = x,
    times = times
  )
  
})
```

```{r,Plot average signal, fig.align='center', echo = FALSE, cache = TRUE}
plot_RLumCarlo(
  object = results, 
  ylab = "normalized TL signal",
  xlab = "Temperature [Â°C]", 
  plot_uncertainty = "range",
  legend = FALSE,
  col = c("black", "green", "blue", "red"),
  norm = TRUE
  
)

legend(
  "topright",
  bty = "n",
  legend = paste0("r_c: ", r_c),
  lty = 1,
  col = c("black", "green", "blue", "red")
)
```
